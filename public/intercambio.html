<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Diferencia (Reestructurada)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">
    <main class="grid grid-cols-1 lg:grid-cols-5 gap-8 w-full max-w-6xl card-shadow">
     <!-- Añade un contenedor para el menú flotante debajo del botón toggle -->
<nav id="globalMenu" 
     class="fixed top-0 left-0 right-0 z-40 flex items-center justify-between px-4 py-2 bg-blue-700 text-white transition-all duration-300 shadow-lg">
  <!-- <div class="font-bold text-lg">Menú</div> -->
  <div class="flex gap-2" id="menuOptions">
    <a href="index.html" class="px-3 py-2 rounded hover:bg-blue-900 transition">Principal</a>
    <a href="intercambio.html" class="px-3 py-2 rounded hover:bg-blue-900 transition">Cálculo Trading</a>
  </div>
  <button id="menuToggle" class="hidden text-2xl focus:outline-none relative z-50" aria-label="Abrir menú">
    ☰
  </button>

  <!-- Contenedor menú desplegable para botón flotante -->
  <div id="floatingMenu" class="hidden fixed bottom-20 right-6 bg-blue-700 text-white rounded-lg shadow-lg py-2 flex flex-col gap-1 z-40">
    <a href="lista.html" class="px-4 py-2 hover:bg-blue-900 rounded">LISTADO PRECIOS</a>
    <a href="index.html" class="px-4 py-2 hover:bg-blue-900 rounded">Principal</a>
  </div>
</nav>


<!-- Espaciador para que el contenido no se oculte tras el menú fijo -->
<div class="h-14"></div>
        <section class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-slate-100 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">⚙ Configuración</h2>
            </div>
            <div class="space-y-5">
                <div>
                    <label for="recibido" class="block mb-2 text-sm font-medium text-slate-600">Equipo Recibido:</label>
                    <select id="recibido" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                      <option value="">Seleccionar Equipo a recibir...</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium text-slate-600">Condiciones del Equipo Recibido</label>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center gap-2"><input type="checkbox" id="soloVentaChk" class="condicion w-4 h-4 text-blue-600 rounded" value="-30"><span>Solo venta </span></label>

                        <label class="flex items-center gap-2"><input type="checkbox" value="-30" class="condicion w-4 h-4 text-blue-600 rounded"><span>Batería &lt; 80% </span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" value="-10" class="condicion w-4 h-4 text-blue-600 rounded"><span>Sin caja </span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" value="-10" class="condicion w-4 h-4 text-blue-600 rounded"><span>Bocinas dañadas </span></label>
                    </div>
                </div>
            </div>
            <div id="tasas" class="mt-8 bg-purple-100 text-purple-800 p-4 rounded-lg flex items-center gap-3 font-semibold">
                Cargando tasas...
            </div>
        </section>
        <section class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg space-y-6">
            <div class="flex items-center gap-3">
                <div class="bg-slate-100 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                </div>
                <h2 id="resultado-titulo" class="text-2xl font-bold text-slate-800">📊 Comparativa Global de Intercambio</h2>
            </div>
            <div id="resultado" class="bg-blue-50 border-t-4 border-blue-500 p-5 rounded-lg space-y-3 overflow-x-auto">
                <p class="text-slate-500">Selecciona el equipo recibido para ver la tabla comparativa.</p>
            </div>
        </section>
    </main>
<script>
    const nav = document.getElementById('globalMenu');
    const menuOptions = document.getElementById('menuOptions');
    const menuToggle = document.getElementById('menuToggle');
    const floatingMenu = document.getElementById('floatingMenu');
    const configSection = document.querySelector('.card-shadow');
    
    /* window.addEventListener('scroll', () => {
      const configTop = configSection.getBoundingClientRect().top + window.scrollY;
      if (window.scrollY >= configTop - nav.offsetHeight) {
        nav.classList.remove('top-0');
        nav.classList.add('bottom-6', 'right-6', 'left-auto', 'rounded-full', 'p-0', 'w-14', 'h-14', 'justify-center', 'items-center');
        menuOptions.classList.add('hidden');
        menuToggle.classList.remove('hidden');
        floatingMenu.classList.add('hidden'); // Esconder menú flotante inicialmente
      } else {
        nav.classList.add('top-0');
        nav.classList.remove('bottom-6', 'right-6', 'left-auto', 'rounded-full', 'p-0', 'w-14', 'h-14', 'justify-center', 'items-center');
        menuOptions.classList.remove('hidden');
        menuToggle.classList.add('hidden');
        floatingMenu.classList.add('hidden'); // Asegurar que el menú flotante esté oculto
      }
    }); */
    window.addEventListener('scroll', () => {
      if (!configSection) return; // seguridad
    
      const configTopViewport = configSection.getBoundingClientRect().top;
    
      if (configTopViewport <= nav.offsetHeight) {
        nav.classList.remove('top-0');
        nav.classList.add('bottom-6', 'right-6', 'left-auto', 'rounded-full', 'p-0', 'w-14', 'h-14', 'justify-center', 'items-center');
        menuOptions.classList.add('hidden');
        menuToggle.classList.remove('hidden');
        floatingMenu.classList.add('hidden');
      } else {
        nav.classList.add('top-0');
        nav.classList.remove('bottom-6', 'right-6', 'left-auto', 'rounded-full', 'p-0', 'w-14', 'h-14', 'justify-center', 'items-center');
        menuOptions.classList.remove('hidden');
        menuToggle.classList.add('hidden');
        floatingMenu.classList.add('hidden');
      }
    });

    
    menuToggle.addEventListener('click', () => {
      floatingMenu.classList.toggle('hidden');
    });

document.addEventListener('DOMContentLoaded', async () => {
    // === DATA ORIGINAL, AJUSTAR SEGÚN TU NECESIDAD ===
    const recibidos = [
  { nombre: "iPhone 11 (64gb)", usd: 120 },
  { nombre: "iPhone 11 (128gb)", usd: 140 },
  { nombre: "iPhone 11 (256gb)", usd: 150 },
  { nombre: "iPhone 11 Pro (64gb)", usd: 180 },
  { nombre: "iPhone 11 Pro (256gb)", usd: 200 },
  { nombre: "iPhone 11 Pro Max (64gb)", usd: 180 },
  { nombre: "iPhone 11 Pro Max (256gb)", usd: 220 },
  { nombre: "iPhone 12 (64gb)", usd: 180 },
  { nombre: "iPhone 12 (128gb)", usd: 200 },
  { nombre: "iPhone 12 (256gb)", usd: 210 },
  { nombre: "iPhone 12 Pro (128gb)", usd: 260 },
  { nombre: "iPhone 12 Pro (256gb)", usd: 280 },
  { nombre: "iPhone 12 Pro (512gb)", usd: 290 },
  { nombre: "iPhone 12 Pro Max (128gb)", usd: 330 },
  { nombre: "iPhone 12 Pro Max (256gb)", usd: 350 },
  { nombre: "iPhone 12 Pro Max (512gb)", usd: 360 },
  { nombre: "iPhone 13 (128gb)", usd: 270 },
  { nombre: "iPhone 13 (256gb)", usd: 290 },
  { nombre: "iPhone 13 (512gb)", usd: 300 },
  { nombre: "iPhone 13 Pro (128gb)", usd: 380 },
  { nombre: "iPhone 13 Pro (256gb)", usd: 400 },
  { nombre: "iPhone 13 Pro (512gb)", usd: 430 },
  { nombre: "iPhone 13 Pro (1TB)", usd: 430 },
  { nombre: "iPhone 13 Pro Max (128gb)", usd: 440 },
  { nombre: "iPhone 13 Pro Max (256gb)", usd: 490 },
  { nombre: "iPhone 13 Pro Max (512gb)", usd: 520 },
  { nombre: "iPhone 13 Pro Max (1TB)", usd: 540 },
  { nombre: "iPhone 14 (128gb)", usd: 320 },
  { nombre: "iPhone 14 (256gb)", usd: 340 },
  { nombre: "iPhone 14 (512gb)", usd: 360 },
  { nombre: "iPhone 14 Plus (128gb)", usd: 300 },
  { nombre: "iPhone 14 Plus (256gb)", usd: 320 },
  { nombre: "iPhone 14 Pro (128gb)", usd: 480 },
  { nombre: "iPhone 14 Pro (256gb)", usd: 500 },
  { nombre: "iPhone 14 Pro (512gb)", usd: 510 },
  { nombre: "iPhone 14 Pro Max (128gb)", usd: 570 },
  { nombre: "iPhone 14 Pro Max (256gb)", usd: 600 },
  { nombre: "iPhone 14 Pro Max (512gb)", usd: 620 },
  { nombre: "iPhone 15 (128gb)", usd: 480 },
  { nombre: "iPhone 15 (256gb)", usd: 500 },
  { nombre: "iPhone 15 (512gb)", usd: 520 },
  { nombre: "iPhone 15 Plus (128gb)", usd: 550 },
  { nombre: "iPhone 15 Plus (256gb)", usd: 590 },
  { nombre: "iPhone 15 Pro (128gb)", usd: 600 },
  { nombre: "iPhone 15 Pro (256gb)", usd: 620 },
  { nombre: "iPhone 15 Pro Max (256gb)", usd: 730 },
  { nombre: "iPhone 15 Pro Max (512gb)", usd: 750 },
  { nombre: "iPhone 15 Pro Max (1TB)", usd: 770 },
  { nombre: "iPhone 16 (128gb)", usd: 660 },
  { nombre: "iPhone 16 (256gb)", usd: 680 },
  { nombre: "iPhone 16 Plus (128gb)", usd: 700 },
  { nombre: "iPhone 16 Plus (256gb)", usd: 730 },
  { nombre: "iPhone 16 Pro (128gb)", usd: 800 },
  { nombre: "iPhone 16 Pro (512gb)", usd: 830 },
  { nombre: "iPhone 16 Pro (1TB)", usd: 870 },
  { nombre: "iPhone 16 Pro Max (256gb)", usd: 900 },
  { nombre: "iPhone 16 Pro Max (512gb)", usd: 940 },
  { nombre: "iPhone 16 Pro Max (1TB)", usd: 960 },

];
    const ventas = [
        { nombre: "iPhone 11 (64gb)", usd: 249 },
  { nombre: "IPhone 11 (128gb)", usd: 279 },
  { nombre: "IPhone 11 (256gb)", usd: 299 },
  { nombre: "iPhone 11 Pro (64gb)", usd: 290 },
  { nombre: "IPhone 11 pro (256gb)", usd: 349 },
  { nombre: "IPhone 11 Pro Max (64gb)", usd: 340 },
  { nombre: "IPhone 11 Pro Max (256gb)", usd: 350 },
  { nombre: "IPhone 12 (64gb)", usd: 285 },
  { nombre: "IPhone 12 (128gb)", usd: 310 },
  { nombre: "IPhone 12 (256gb)", usd: 340 },
  { nombre: "Iphone 12 Pro (128gb)", usd: 380 },
  { nombre: "IPhone 12 Pro (256gb)", usd: 410 },
  { nombre: "IPhone 12 Pro (512gb)", usd: 445 },
  { nombre: "IPhone 12 Pro Max (128gb)", usd: 449 },
  { nombre: "IPhone 12 Pro Max (256gb)", usd: 479 },
  { nombre: "IPhone 12 Pro Max (512gb)", usd: 520 },
  { nombre: "IPhone 13 (128gb)", usd: 390 },
  { nombre: "IPhone 13 (256gb)", usd: 419 },
  { nombre: "IPhone 13 (512gb)", usd: 429 },
  { nombre: "IPhone 13 Pro (128gb)", usd: 489 },
  { nombre: "IPhone 13 Pro (256gb)", usd: 529 },
  { nombre: "IPhone 13 Pro (512gb)", usd: 559 },
  { nombre: "IPhone 13 Pro (1TB)", usd: 580 },
  { nombre: "IPhone 13 Pro Max (128gb)", usd: 570 },
  { nombre: "IPhone 13 Pro Max (256gb)", usd: 620 },
  { nombre: "IPhone 13 Pro Max (512gb)", usd: 649 },
  { nombre: "IPhone 13 Pro Max (1TB)", usd: 669 },
  { nombre: "IPhone 14 (128gb)", usd: 429 },
  { nombre: "IPhone 14 (256gb)", usd: 459 },
  { nombre: "IPhone 14 (512gb)", usd: 489 },
  { nombre: "IPhone 14 Plus (128gb)", usd: 439 },
  { nombre: "IPhone 14 Plus (256gb)", usd: 479 },
  { nombre: "IPhone 14 Pro (128gb)", usd: 599 },
  { nombre: "IPhone 14 Pro (256gb)", usd: 629 },
  { nombre: "IPhone 14 Pro (512gb)", usd: 649 },
  { nombre: "IPhone 14 Pro Max (128gb)", usd: 699 },
  { nombre: "IPhone 14 Pro Max (256gb)", usd: 729 },
  { nombre: "IPhone 14 Pro Max (512gb)", usd: 779 },
  { nombre: "IPhone 15 (128gb)", usd: 639 },
  { nombre: "IPhone 15 (256gb)", usd: 679 },
  { nombre: "IPhone 15 (512gb)", usd: 689 },
  { nombre: "IPhone 15 Plus (128gb)", usd: 690 },
  { nombre: "IPhone 15 Plus (256gb)", usd: 720 },
  { nombre: "IPhone 15 Pro (128gb)", usd: 780 },
  { nombre: "IPhone 15 Pro (256gb)", usd: 820 },
  { nombre: "IPhone 15 Pro Max (256gb)", usd: 870 },
  { nombre: "IPhone 15 Pro Max (512gb)", usd: 930 },
  { nombre: "IPhone 15 Pro Max (1TB)", usd: 960 },
  { nombre: "IPhone 16 (128gb)", usd: 819 },
  { nombre: "IPhone 16 (256gb)", usd: 849 },
  { nombre: "IPhone 16 Plus (128gb)", usd: 870 },
  { nombre: "IPhone 16 Plus (256gb)", usd: 900 },
  { nombre: "IPhone 16 Pro (128gb)", usd: 970 },
  { nombre: "IPhone 16 Pro (512gb)", usd: 1120 },
  { nombre: "IPhone 16 Pro (1TB)", usd: 1160 },
  { nombre: "IPhone 16 Pro Max (256gb)", usd: 1159 },
  { nombre: "IPhone 16 Pro Max (512gb)", usd: 1230 },
  { nombre: "IPhone 16 Pro Max (1TB)", usd: 1350 }
    ];

    // === ELEMENTOS DEL DOM ===
    const selRecibido = document.getElementById('recibido');
    const condiciones = document.querySelectorAll('.condicion');
    const tasasDiv = document.getElementById('tasas');
    const resultadoDiv = document.getElementById('resultado');

    // === LLENAR SELECT DE RECIBIDOS ===
    recibidos.forEach(p =>
      selRecibido.innerHTML += `<option value="${p.usd}">${p.nombre}</option>`
    );

    // === ESTADO DE TASAS (SIMULADO/MODIFIQUE SEGÚN SU API) ===
    async function fetchTasa(url, tasa) {
        try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        // El valor viene como string, lo convertimos a número
        if (tasa === "BCV"){
            return parseFloat(data.rates.VES);
        } else if (tasa === "BNC"){
            return /* data.stats.trimmedAverage || */ data.stats.average - 4;
        }
        //return parseFloat(data.rates.VES);
        } catch (err) {
        console.error(`Error obteniendo tasa ${tasa}:`, err);
        return null;
        }
    }
    let tasaBinance = await fetchTasa("/.netlify/functions/binance-p2p-average?asset=USDT&fiat=VES&tradeType=SELL&rows=20&trim=0.1", "BNC")
    let tasaBCV = await fetchTasa("https://open.er-api.com/v6/latest/USD", "BCV")

    tasasDiv.textContent = `BNC: ${tasaBinance.toFixed(2)} | Tasa BCV: Bs ${tasaBCV.toFixed(2)}`;

    // === FUNCIONES DE FORMATEO ===
    const formatUSD = num =>
      `$${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    const formatBS = num =>
      `Bs ${num.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

    // === FUNCIÓN DE CÁLCULO NUEVA (TABLA GLOBAL) ===
    function calcular() {
    if (!tasaBinance || !tasaBCV || !selRecibido.value) {
        resultadoDiv.innerHTML = `<p class="text-slate-500">Selecciona el equipo recibido para ver la tabla comparativa.</p>`;
        return;
    }

    let precioRecibido = parseFloat(selRecibido.value);
    condiciones.forEach(chk => {
        if (chk.checked) {
            precioRecibido += parseFloat(chk.value);
        }
    });

    // Verifica si "Solo venta" está activado
    const soloVentaChk = document.getElementById('soloVentaChk');
    if(soloVentaChk && soloVentaChk.checked) {
        const totalBs = precioRecibido * tasaBinance;
        resultadoDiv.innerHTML = `
          <div class="mb-6 bg-green-100 rounded-lg p-4 flex flex-col gap-2">
            <span class="text-slate-600 font-medium">Monto recibido (ajustado):</span>
            <span class="font-bold text-green-900 text-xl">${formatUSD(precioRecibido)}</span>
            <hr/>
            <span class="text-slate-600 font-medium">Total a cancelar al cliente:</span>
            <span class="font-bold text-blue-600 text-lg">${formatBS(totalBs)}</span>
          </div>
          <div class="mt-2 text-slate-500 text-sm">Modo solo venta: entrega directa de efectivo, sin tabla comparativa.</div>
        `;
        return;
    }

    // Modo tabla comparativa (normal)
    let bloqueRecibido = `
      <div class="mb-6 bg-blue-100 rounded-lg p-4 flex justify-between items-center">
        <span class="text-slate-600 font-medium">Monto recibido (ajustado):</span>
        <span class="font-bold text-blue-900 text-xl">${formatUSD(precioRecibido)}</span>
      </div>
    `;

    let tabla = `<table class="min-w-full divide-y divide-slate-300 text-xs md:text-sm">
        <thead class="bg-slate-200">
          <tr>
            <th class="px-2 py-2 text-left font-bold">Equipo de Venta</th>
            <th class="px-2 py-2 text-right font-bold">Diferencia USD</th>
            <th class="px-2 py-2 text-right font-bold">Equivalente Bolívares</th>
            <th class="px-2 py-2 text-right font-bold">Equiv. BCV USD</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">`;

    ventas.forEach(venta => {
        const diferenciaUSD = venta.usd - precioRecibido;
        if (/* diferenciaUSD > 0 */0<1) {
            const diferenciaBs = diferenciaUSD * tasaBinance;
            const diferenciaBCV = diferenciaBs / tasaBCV;
            tabla += `<tr class="hover:bg-blue-100">
                <td class="px-2 py-1">${venta.nombre}</td>
                <td class="px-2 py-1 text-right">${formatUSD(diferenciaUSD)}</td>
                <td class="px-2 py-1 text-right">${formatBS(diferenciaBs)}</td>
                <td class="px-2 py-1 text-right">${formatUSD(diferenciaBCV)}</td>
            </tr>`;
        }
    });
    tabla += '</tbody></table>';

    resultadoDiv.innerHTML = bloqueRecibido + tabla;
}


    // === EVENTOS ===
    selRecibido.addEventListener('change', calcular);
    condiciones.forEach(chk => chk.addEventListener('change', calcular));

});
</script>
</body>
</html>
