<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lista de Precios en Bs</title>
  <style>

    /* üéØ Estilos solo para impresi√≥n */
    @media print {
      body::before {
        /* content: "Lista de Precios en Bol√≠vares - Actualizado"; */
        display: block;
        text-align: center;
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 10px;
      }
      /* Ocultar tasa, botones y cualquier otro elemento que no quieras imprimir */
      #tasa,
      #btnImprimir,
      #btnDescargar,
      button,
      a,
      h1,
      .acciones,
      header,
      footer {
        display: none !important;
      }
    
      /* Ajustar la tabla para ocupar todo el ancho al imprimir */
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 0 auto;
      }
    
      th, td {
        border: 1px solid #000;
        padding: 6px;
      }
    
      body {
        background: white;   /* Fondo limpio */
        color: black;        /* Texto negro */
      }
    }
    
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin: 0 auto; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #333; color: #fff; }
    tr:nth-child(even) { background: #fafafa; }
    .bs { font-weight: bold; color: green; }
  </style>
</head>
<body>
  <h1>üí± Lista de Precios en Bs </h1>
  <p id="tasa">Cargando tasa...</p>

  <div style="margin-top: 20px;">
    <button id="btnImprimir">üñ® Imprimir lista</button>
    <button id="btnDescargar">üíæ Descargar CSV</button>
    <button class="py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600" >
        <a href="/">üí± Volver a Calculadora...</a>
    </button>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>Producto</th>
        <th>Precio Bs</th>
        <th>Estimado $ BCV</th>
        <th>Oferta Divisas</th>
      </tr>
    </thead>
    <tbody id="tabla-productos"></tbody>
  </table>

  <script>
    async function fetchTasaBCV() {
      try {
        const res = await fetch("https://open.er-api.com/v6/latest/USD");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        // El valor viene como string, lo convertimos a n√∫mero
        return parseFloat(data.rates.VES);
      } catch (err) {
        console.error("Error obteniendo tasa BCV:", err);
        return null;
      }
    }

    
    /* const productos = [
      { nombre: "iPhone 11 (64gb)", usd: 259 },
      { nombre: "iPhone 11 (128gb)", usd: 279 },
      { nombre: "iPhone 11 (256gb)", usd: 299 },
      { nombre: "iPhone 11 Pro (64gb)", usd: 290 },
      { nombre: "iPhone 11 Pro (256gb)", usd: 349 },
      { nombre: "iPhone 11 Pro Max (64gb)", usd: 340 },
      { nombre: "iPhone 11 Pro Max (256gb)", usd: 350 },
      { nombre: "iPhone 12 (64gb)", usd: 290 },
      { nombre: "iPhone 12 (128gb)", usd: 339 },
      { nombre: "iPhone 12 (256gb)", usd: 365 },
      { nombre: "iPhone 12 Pro (128gb)", usd: 380 },
      { nombre: "iPhone 12 Pro (256gb)", usd: 410 },
      { nombre: "iPhone 12 Pro (512gb)", usd: 445 },
      { nombre: "iPhone 12 Pro Max (128gb)", usd: 449 },
      { nombre: "iPhone 12 Pro Max (256gb)", usd: 479 },
      { nombre: "iPhone 12 Pro Max (512gb)", usd: 520 },
      { nombre: "iPhone 13 (128gb)", usd: 390 },
      { nombre: "iPhone 13 (256gb)", usd: 420 },
      { nombre: "iPhone 13 (512gb)", usd: 440 },
      { nombre: "iPhone 13 Pro (128gb)", usd: 509 },
      { nombre: "iPhone 13 Pro (256gb)", usd: 539 },
      { nombre: "iPhone 13 Pro (512gb)", usd: 559 },
      { nombre: "iPhone 13 Pro (1TB)", usd: 580 },
      { nombre: "iPhone 13 Pro Max (128gb)", usd: 589 },
      { nombre: "iPhone 13 Pro Max (256gb)", usd: 639 },
      { nombre: "iPhone 13 Pro Max (512gb)", usd: 659 },
      { nombre: "iPhone 13 Pro Max (1TB)", usd: 669 },
      { nombre: "iPhone 14 (128gb)", usd: 439 },
      { nombre: "iPhone 14 (256gb)", usd: 469 },
      { nombre: "iPhone 14 (512gb)", usd: 489 },
      { nombre: "iPhone 14 Plus (128gb)", usd: 499 },
      { nombre: "iPhone 14 Plus (256gb)", usd: 519 },
      { nombre: "iPhone 14 Pro (128gb)", usd: 609 },
      { nombre: "iPhone 14 Pro (256gb)", usd: 629 },
      { nombre: "iPhone 14 Pro (512gb)", usd: 649 },
      { nombre: "iPhone 14 Pro Max (128gb)", usd: 699 },
      { nombre: "iPhone 14 Pro Max (256gb)", usd: 739 },
      { nombre: "iPhone 14 Pro Max (512gb)", usd: 779 },
      { nombre: "iPhone 15 (128gb)", usd: 639 },
      { nombre: "iPhone 15 (256gb)", usd: 679 },
      { nombre: "iPhone 15 (512gb)", usd: 689 },
      { nombre: "iPhone 15 Plus (128gb)", usd: 690 },
      { nombre: "iPhone 15 Plus (256gb)", usd: 720 },
      { nombre: "iPhone 15 Pro (128gb)", usd: 780 },
      { nombre: "iPhone 15 Pro (256gb)", usd: 820 },
      { nombre: "iPhone 15 Pro Max (256gb)", usd: 890 },
      { nombre: "iPhone 15 Pro Max (512gb)", usd: 979 },
      { nombre: "iPhone 15 Pro Max (1TB)", usd: 970 },
      { nombre: "iPhone 16 (128gb)", usd: 819 },
      { nombre: "iPhone 16 (256gb)", usd: 849 },
      { nombre: "iPhone 16 Plus (128gb)", usd: 869 },
      { nombre: "iPhone 16 Plus (256gb)", usd: 919 },
      { nombre: "iPhone 16 Pro (128gb)", usd: 1050 },
      { nombre: "iPhone 16 Pro (512gb)", usd: 1120 },
      { nombre: "iPhone 16 Pro (1TB)", usd: 1160 },
      { nombre: "iPhone 16 Pro Max (256gb)", usd: 1159 },
      { nombre: "iPhone 16 Pro Max (512gb)", usd: 1230 },
      { nombre: "iPhone 16 Pro Max (1TB)", usd: 1350 }
    ]; */
    const productos = [
      { nombre: "iPhone 11 (64gb)", usd: 249 }, // Cambi√≥ de 259 a 249
      { nombre: "IPhone 11 (128gb)", usd: 279 }, // Igual
      { nombre: "IPhone 11 (256gb)", usd: 299 }, // Igual
      { nombre: "iPhone 11 Pro (64gb)", usd: 290 }, // Igual
      { nombre: "IPhone 11 pro (256gb)", usd: 349 }, // Igual
      { nombre: "IPhone 11 Pro Max (64gb)", usd: 340 }, // Igual
      { nombre: "IPhone 11 Pro Max (256gb)", usd: 350 }, // Igual
      { nombre: "IPhone 12 (64gb)", usd: 285 }, // Cambi√≥ de 290 a 285
      { nombre: "IPhone 12 (128gb)", usd: 310 }, // Cambi√≥ de 339 a 310
      { nombre: "IPhone 12 (256gb)", usd: 340 }, // Cambi√≥ de 365 a 340
      { nombre: "Iphone 12 Pro (128gb)", usd: 380 }, // Igual
      { nombre: "IPhone 12 Pro (256gb)", usd: 410 }, // Igual
      { nombre: "IPhone 12 Pro (512gb)", usd: 445 }, // Igual
      { nombre: "IPhone 12 Pro Max (128gb)", usd: 449 }, // Igual
      { nombre: "IPhone 12 Pro Max (256gb)", usd: 479 }, // Igual
      { nombre: "IPhone 12 Pro Max (512gb)", usd: 520 }, // Igual
      { nombre: "IPhone 13 (128gb)", usd: 390 }, // Igual pero agregaste "clase A" en el texto
      { nombre: "IPhone 13 (256gb)", usd: 419 }, // Cambi√≥ de 420 a 419
      { nombre: "IPhone 13 (512gb)", usd: 429 }, // Cambi√≥ de 440 a 429
      { nombre: "IPhone 13 Pro (128gb)", usd: 489 }, // Cambi√≥ de 509 a 489
      { nombre: "IPhone 13 Pro (256gb)", usd: 529 }, // Cambi√≥ de 539 a 529
      { nombre: "IPhone 13 Pro (512gb)", usd: 559 }, // Igual
      { nombre: "IPhone 13 Pro (1TB)", usd: 580 }, // Igual
      { nombre: "IPhone 13 Pro Max (128gb)", usd: 570 }, // Cambi√≥ de 589 a 570
      { nombre: "IPhone 13 Pro Max (256gb)", usd: 620 }, // Cambi√≥ de 639 a 620
      { nombre: "IPhone 13 Pro Max (512gb)", usd: 649 }, // Igual
      { nombre: "IPhone 13 Pro Max (1TB)", usd: 669 }, // Igual
      { nombre: "IPhone 14 (128gb)", usd: 429 }, // Cambi√≥ de 439 a 429
      { nombre: "IPhone 14 (256gb)", usd: 459 }, // Cambi√≥ de 469 a 459
      { nombre: "IPhone 14 (512gb)", usd: 489 }, // Igual
      { nombre: "IPhone 14 Plus (128gb)", usd: 439 }, // Cambi√≥ de 499 a 439
      { nombre: "IPhone 14 Plus (256gb)", usd: 479 }, // Cambi√≥ de 519 a 479
      { nombre: "IPhone 14 Pro (128gb)", usd: 599 }, // Cambi√≥ de 609 a 599
      { nombre: "IPhone 14 Pro (256gb)", usd: 629 }, // Igual
      { nombre: "IPhone 14 Pro (512gb)", usd: 649 }, // Igual
      { nombre: "IPhone 14 Pro Max (128gb)", usd: 699 }, // Igual
      { nombre: "IPhone 14 Pro Max (256gb)", usd: 729 }, // Cambi√≥ de 739 a 729
      { nombre: "IPhone 14 Pro Max (512gb)", usd: 779 }, // Igual
      { nombre: "IPhone 15 (128gb)", usd: 639 }, // Igual
      { nombre: "IPhone 15 (256gb)", usd: 679 }, // Igual
      { nombre: "IPhone 15 (512gb)", usd: 689 }, // Igual
      { nombre: "IPhone 15 Plus (128gb)", usd: 690 }, // Igual
      { nombre: "IPhone 15 Plus (256gb)", usd: 720 }, // Igual
      { nombre: "IPhone 15 Pro (128gb)", usd: 780 }, // Igual
      { nombre: "IPhone 15 Pro (256gb)", usd: 820 }, // Igual
      { nombre: "IPhone 15 Pro Max (256gb)", usd: 870 }, // Cambi√≥ de 890 a 870
      { nombre: "IPhone 15 Pro Max (512gb)", usd: 930 }, // Cambi√≥ de 979 a 930
      { nombre: "IPhone 15 Pro Max (1TB)", usd: 960 }, // Cambi√≥ de 970 a 960
      { nombre: "IPhone 16 (128gb)", usd: 819 }, // Igual
      { nombre: "IPhone 16 (256gb)", usd: 849 }, // Igual
      { nombre: "IPhone 16 Plus (128gb)", usd: 819 }, // Cambi√≥ de 869 a 819
      { nombre: "IPhone 16 Plus (256gb)", usd: 890 }, // Cambi√≥ de 919 a 890
      { nombre: "IPhone 16 Pro (128gb)", usd: 970 }, // Cambi√≥ de 1050 a 970
      { nombre: "IPhone 16 Pro (512gb)", usd: 1120 }, // Igual
      { nombre: "IPhone 16 Pro (1TB)", usd: 1160 }, // Igual
      { nombre: "IPhone 16 Pro Max (256gb)", usd: 1159 }, // Igual
      { nombre: "IPhone 16 Pro Max (512gb)", usd: 1230 }, // Igual
      { nombre: "IPhone 16 Pro Max (1TB)", usd: 1350 } // Igual
    ];



    async function fetchTasaYCalcular() {
      try {
        const res = await fetch('/.netlify/functions/binance-p2p-average?asset=USDT&fiat=VES&tradeType=SELL&rows=20&trim=0.1');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.ok) throw new Error(data.message || 'Respuesta no v√°lida');

        console.log('Binance P2P data:', data);

    // Tomamos los valores
    const promedioo = /* data.stats.trimmedAverage ||  */data.stats.average;
    const maximo = data.stats.max;

    // Calculamos la diferencia
    const diferencia = Math.abs(maximo - promedioo);

    // Si la diferencia es menor a 1.8 usamos el promedio, si no, el m√°ximo
    let promedio = /* diferencia < 1.8 ? promedioo : maximo */promedioo;

        //let promedio = /* data.stats.trimmedAverage || */ data.stats.average;
        console.log(promedio.toFixed(2));
        promedio = parseFloat(promedio.toFixed(2)) + 3;
        console.log(promedio.toFixed(2));

        // 2Ô∏è‚É£ Obtener tasa BCV en vivo
        const tasaBCV = await fetchTasaBCV();
        if (!tasaBCV) throw new Error("No se pudo obtener la tasa BCV");
        
        document.getElementById('tasa').textContent = `Tasa Binance P2P: Bs ${parseInt(promedio.toFixed(2))}`;

        const tbody = document.getElementById('tabla-productos');
        tbody.innerHTML = '';

        productos.forEach(p => {
          //const precioBs = p.usd * promedio;
          /* const precioBs = p.usd * promedio;
          const precioFormateado = Math.round(precioBs).toLocaleString("es-VE"); */
          const precioBs = p.usd * promedio;
          const precioFormateado = Math.round(precioBs).toLocaleString("es-VE");
          const estimadoBCV = precioBs / tasaBCV; // Bs ‚Üí USD usando BCV
          const ofertaDivisas = p.usd; // USD base

          const fila = `<tr>
            <td>${p.nombre}</td>
            <td class="bs">Bs ${/* precioBs.toFixed(2) */precioFormateado}</td>
            <td>$ ${estimadoBCV.toFixed(2)}(BCV)</td>
            <td>$${ofertaDivisas.toFixed(2)}(Divisas/Zelle/Binance)</td>
          </tr>`;
          tbody.innerHTML += fila;
        });
        } catch (err) {
          console.error(err);
          document.getElementById('tasa').textContent = 'Error al obtener tasa';
        }
      }

    // Bot√≥n para imprimir
    document.getElementById('btnImprimir').addEventListener('click', () => {
      window.print();
    });
  
    // Bot√≥n para descargar CSV
    document.getElementById('btnDescargar').addEventListener('click', () => {
      const filas = document.querySelectorAll('#tabla-productos tr');
      let csv = "Producto,Precio Bs\n";
      filas.forEach(fila => {
        const cols = fila.querySelectorAll('td');
        const producto = cols[0].innerText;
        const precio = cols[1].innerText.replace("Bs", "").trim();
        csv += `"${producto}",${precio}\n`;
      });
  
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
  
      const enlace = document.createElement('a');
      enlace.href = url;
      enlace.download = 'lista_precios.csv';
      enlace.click();
  
      URL.revokeObjectURL(url);
    });

    fetchTasaYCalcular();
  </script>
</body>
</html>
